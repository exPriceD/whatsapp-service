# Миграции базы данных (golang-migrate)

Этот проект использует [golang-migrate](https://github.com/golang-migrate/migrate) для управления схемой базы данных PostgreSQL. Все изменения структуры БД оформляются в виде версионируемых миграций (SQL-файлов) в этой папке.

---

## Структура папки

- `NNN_name.up.sql`   — SQL для применения миграции (создание/изменение/добавление)
- `NNN_name.down.sql` — SQL для отката миграции (отмена изменений)
- `README.md`         — эта документация

---

## Быстрый старт

1. **Создайте базу данных (один раз):**
   ```sh
   make create-db db=whatsapp_service
   ```
2. **Примените все миграции:**
   ```sh
   make migrate-up
   ```
3. **Проверьте структуру БД** — все нужные таблицы будут созданы автоматически.

---

## Основные команды

- **Создать новую миграцию:**
  ```sh
  make new-migration name=add_users_table
  ```
  > Появятся два файла: `NNN_add_users_table.up.sql` и `NNN_add_users_table.down.sql`.
- **Применить миграции:**
  ```sh
  make migrate-up
  ```
- **Откатить одну миграцию:**
  ```sh
  make migrate-down
  ```
- **Показать текущую версию миграции:**
  ```sh
  make migrate-version
  ```
- **Создать новую базу данных:**
  ```sh
  make create-db db=whatsapp_service
  ```

---

## Как писать миграции

- В файл `.up.sql` — SQL для применения изменений (например, создать таблицу, добавить столбец).
- В файл `.down.sql` — SQL для отката изменений (например, удалить таблицу, убрать столбец).
- Пример:
  - `003_add_column_to_settings.up.sql`:
    ```sql
    ALTER TABLE whatsgate_settings ADD COLUMN is_active BOOLEAN DEFAULT true;
    ```
  - `003_add_column_to_settings.down.sql`:
    ```sql
    ALTER TABLE whatsgate_settings DROP COLUMN is_active;
    ```

---

## Удаление ошибочной миграции

- **Если миграция не применялась** — просто удалите оба файла (`.up.sql` и `.down.sql`).
- **Если миграция уже применялась** — сначала откатите её (`make migrate-down`), затем удалите файлы.
- **Если ошибочная миграция не последняя** — откатите миграции до нужной версии, удалите файлы, затем снова примените миграции.

---

## Best practices

- Не редактируйте и не удаляйте миграции, которые уже применялись на продакшене или у других разработчиков.
- Всегда пишите откат (`down.sql`) для каждой миграции.
- Храните миграции в git — это часть истории проекта.
- Для каждого изменения схемы создавайте отдельную миграцию.
- Проверяйте миграции на тестовой базе перед применением в продакшене.

---

## Пример строки подключения

```
postgres://postgres:postgres@localhost:5433/whatsapp_service?sslmode=disable
```

---

## FAQ и Troubleshooting

**Q: Как узнать, какие миграции уже применены?**
A: Используйте команду `make migrate-version` — она покажет текущую версию. В базе есть служебная таблица `schema_migrations`.

**Q: Что делать, если миграция не применяется?**
A: Проверьте строку подключения, наличие базы, корректность SQL. Сообщения об ошибках обычно указывают на причину.

**Q: Как пересоздать базу с нуля?**
A:
1. Удалите старую базу (через psql или make create-db с другим именем).
2. Создайте новую базу: `make create-db db=whatsapp_service`
3. Примените миграции: `make migrate-up`

**Q: Как откатить несколько миграций?**
A: Используйте команду:
```sh
migrate -path ./migrations -database "<строка_подключения>" down N
```
Где N — количество миграций для отката.

---

## Полезные ссылки
- [golang-migrate/migrate (GitHub)](https://github.com/golang-migrate/migrate)
- [Документация по SQL для PostgreSQL](https://www.postgresql.org/docs/current/sql.html)